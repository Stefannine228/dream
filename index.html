<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="utf-8">
    <title>Визначення місця</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.10.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.10.0/mapbox-gl.js"></script>
    <link rel="stylesheet" href="main.css">
</head>
<body>

<!-- Форма для введення міста -->
<div id="locationPrompt">
    <form >
        <h3>Введіть своє місто</h3>
        <input class="Nunition" type="text" id="cityInput" placeholder="Наприклад: Львів">
        <button type="submit" class="Nunition" id="cityEnter">Знайти</button>
    </form>
</div>

<!-- Карта -->
<div id="map"></div>



<div id="infoBox">
    <button class="Nunition-text" id="closeBtn" onclick="closeInfoBox()">Close ❌</button>
     <div class="addData">
    <label class="Nunition-text">Location Name:</label>
    <input class="Nunition-text" type="text" id="placeName" placeholder="Enter name">
    <label class="Nunition-text ">Description:</label>
    <input class="Nunition-text" type="text" id="placeDesc" placeholder="Describe the issue">
    <input class="Nunition-text" type="button" id="add addDataBtn" onclick="saveMarker()" value="Add"></input>
     <button id="login">Вхід</button>
     </div>
</div>


<script>
   mapboxgl.accessToken = 'pk.eyJ1Ijoicm9tYW5rcmF2ZXRzIiwiYSI6ImNrZ2hzajNpejAweDYycW14NXZtYjJycWYifQ.0VN2Nw-1t2JfOHlcSlTYmg';

let map;
let selectedCoords = null;
let markData = null; // Initialize markData

// Function to search for city coordinates
async function getCityCoordinates(city) {
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${city}`;
    const response = await fetch(url);
    const data = await response.json();
    if (data.length > 0) {
        return [parseFloat(data[0].lon), parseFloat(data[0].lat)];
    } else {
        return null;
    }
}

async function setMapLocation() {
    event.preventDefault(); 
    const city = document.getElementById("cityInput").value;
    if (!city) {
        alert("Будь ласка, введіть місто!");
        return;
    }

    const coordinates = await getCityCoordinates(city);
    if (coordinates) {
        initializeMap(coordinates);
    } else {
        alert("Не вдалося знайти це місто. Введіть інше.");
    }
    return false;
}

// Function to initialize the map
function initializeMap(centerCoords) {
    document.getElementById("locationPrompt").style.display = "none";
    document.getElementById("map").style.display = "block";

    map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v12',
        center: centerCoords,
        zoom: 12
    });

    const marker = new mapboxgl.Marker({ color: "blue" })
        .setLngLat(centerCoords)
        .setPopup(new mapboxgl.Popup().setHTML("<strong>Ваша локація</strong>"))
        .addTo(map);

    map.on('mouseenter', () => {
        map.getCanvas().style.cursor = 'crosshair';
    });

    map.on('mouseleave', () => {
        map.getCanvas().style.cursor = '';
    });

    map.on('click', (event) => {
        selectedCoords = event.lngLat;
        let markerClicked = false;
        const markerElements = document.getElementsByClassName('mapboxgl-marker');
        const clickX = event.originalEvent.clientX;
        const clickY = event.originalEvent.clientY;

        for (let i = 0; i < markerElements.length; i++) {
            const boundingBox = markerElements[i].getBoundingClientRect();
            if (clickX >= boundingBox.left && clickX <= boundingBox.right &&
                clickY >= boundingBox.top && clickY <= boundingBox.bottom) {
                markerClicked = true;
                break;
            }
        }

        if (!markerClicked) {
            if (!markData) {
                markData = new mapboxgl.Marker({ color: "green" })
                    .setLngLat(selectedCoords)
                    .addTo(map);
                document.getElementById("infoBox").style.display = "block";
            } else {
                closeInfoBox()
                markData.remove();
                markData = null;
                document.getElementById("infoBox").style.display = "none";
                document.getElementById("infoBox").style.display = "block";
            }
        } else {
            document.getElementById("infoBox").style.display = "none";
        }
    });
}

function getUserLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const userCoords = [position.coords.longitude, position.coords.latitude];
                initializeMap(userCoords);
            },
            () => {
                document.getElementById("locationPrompt").style.display = "block";
            }
        );
    } else {
        document.getElementById("locationPrompt").style.display = "block";
    }
}

getUserLocation();

function saveMarker() {
    const placeName = document.getElementById("placeName").value;
    const placeDesc = document.getElementById("placeDesc").value;

    if (!placeName || !placeDesc) {
        alert("Please enter name and description!");
        return;
    }

    if (!selectedCoords) {
        alert("Please select a point on the map!");
        return;
    }
    markData = new mapboxgl.Marker({ color: "red" })
                .setLngLat(selectedCoords)
                .setPopup(new mapboxgl.Popup().setHTML(`<h3 class="maker1">${placeName}</h3><p class="maker1">${placeDesc}</p>`))
                .addTo(map);
    markData = null;

    closeInfoBox();
}

function closeInfoBox() {
    document.getElementById("infoBox").style.display = "none";
    document.getElementById("placeName").value = "";
    document.getElementById("placeDesc").value = "";

    if (markData) {
        markData.remove();
        markData = null;
    }
}

document.getElementById("cityEnter").addEventListener("click", setMapLocation);

</script>
<script type="module" src="firebaseApp.js"></script>
<script type="module" src="script.js"></script>
</body>
</html>
